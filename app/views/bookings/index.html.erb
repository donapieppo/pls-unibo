<div class="container">
  <h1 class="title">Le iscrizioni</h1>
  <% @booked_activities.each do |a| %>  
    <% activity_online_mails = []; activity_in_presence_mails = [] %>  
    <% booking_to_confirm = a.booking_to_confirm? %>  
    <div class="pls-card my-8">
      <div class="pls-card-title">
        <%= link_to a.name.upcase, a %>
        <%= link_to_edit_if_editable a %>  
      </div>
      <div class="pls-card-content">
        <div>
          <%= l a.booking_start, format: :short %> - <%= l a.booking_end, format: :short %>
        </div>
        <div>
          <%= '<strong>Attivit√† con prenotazioni da confermare</strong>'.html_safe if booking_to_confirm %>  
        </div>
        <div>
          Posti totali: <strong><%= a.seats %></strong><br/>
          Posti prentati: <strong><%= a.bookings.in_presence.sum(:seats) %></strong> <br/> 
          Prenotazioni online: <strong><%= a.bookings.online.count(:seats) %></strong>
        </div>
        <p>Elenco iscritti:</p>
        <ul class="list-disc pl-8">
          <% a.bookings.order(:created_at).each do |b| %>  
            <li>
              <span class="font-mono"><%= b.nonce ? b.nonce : '-----' %></span> 
              <small><%= l b.created_at %></small>
              <% if b.online %>  
                <% activity_online_mails << b.email %>  
                <span class="text-yellow-500">online</span>
              <% else %>
                <% activity_in_presence_mails << b.email %>  
                <strong><%= b.seats %></strong> <%= b.seats == 1 ? 'posto' : 'posti' %> per  
              <% end %>
              <% if b.user %>  
                <span class="font-bold text-green-700 underline"><%= link_to b.user, [:edit, b.user] %></span>     
              <% else %>
                <%= b.name %> <%= b.surname %>
              <% end %>
              <%= b.role %> 
              <%= b.school_type %>  
              <%= b.school %>  
              (<%= mail_to b.email %>) 
              <%= link_to_delete b %> 
              <% if booking_to_confirm && ! b.confirmed? %>  
                <%= link_to '<i class="far fa-check-circle"></i> conferma'.html_safe, confirm_booking_path(b), method: :post, class: 'underline' %>  
              <% else %>
                <span class="text-green-500"><i class="fas fa-check-circle"></i> confermata</span>
              <% end %>
            </li>
          <% end %>
        </ul>
      </div>
      <div class="info text-sm my-2">
        <strong>Indirizzi partecipanti in presenza:</strong> <%= activity_in_presence_mails.join(', ') %>  
      </div>
      <div class="info text-sm my-2">
        <strong>Indirizzi partecipanti online:</strong> <%= activity_online_mails.join(', ') %>  
      </div>
      <%= link_to 'scarica elenco', bookings_path(activity_id: a.id, format: :csv) %>  
    </div>
  <% end %>
</div>
